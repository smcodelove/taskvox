{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">Voice Campaigns</h1>
        <p class="text-muted">Create and manage bulk calling campaigns</p>
    </div>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createCampaignModal">
        <i class="fas fa-plus me-2"></i>Create Campaign
    </button>
</div>

<!-- Campaigns List -->
{% if campaigns %}
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>All Campaigns
            </h5>
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Campaign Name</th>
                        <th>Agent</th>
                        <th>Status</th>
                        <th>Progress</th>
                        <th>Success Rate</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for campaign in campaigns %}
                    <tr>
                        <td>
                            <strong>{{ campaign.name }}</strong>
                        </td>
                        <td>
                            {% for agent in agents %}
                                {% if agent.id == campaign.agent_id %}
                                    {{ agent.name }}
                                {% endif %}
                            {% endfor %}
                        </td>
                        <td>
                            <span class="badge status-{{ campaign.status }}">
                                {{ campaign.status|title }}
                            </span>
                        </td>
                        <td>
                            <div class="progress" style="width: 100px;">
                                {% set progress = (campaign.completed_calls / campaign.total_contacts * 100) if campaign.total_contacts > 0 else 0 %}
                                <div class="progress-bar" style="width: {{ progress }}%"></div>
                            </div>
                            <small class="text-muted">{{ campaign.completed_calls }}/{{ campaign.total_contacts }}</small>
                        </td>
                        <td>
                            {% if campaign.completed_calls > 0 %}
                                {{ "%.1f"|format((campaign.successful_calls / campaign.completed_calls * 100)) }}%
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">{{ campaign.created_at.strftime('%Y-%m-%d') }}</small>
                        </td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                    Actions
                                </button>
                                <ul class="dropdown-menu">
                                    {% if campaign.status == 'pending' %}
                                        <li><a class="dropdown-item" href="#" onclick="launchCampaign({{ campaign.id }})">
                                            <i class="fas fa-play me-2"></i>Launch
                                        </a></li>
                                    {% elif campaign.status == 'running' %}
                                        <li><a class="dropdown-item" href="#" onclick="pauseCampaign({{ campaign.id }})">
                                            <i class="fas fa-pause me-2"></i>Pause
                                        </a></li>
                                    {% elif campaign.status == 'paused' %}
                                        <li><a class="dropdown-item" href="#" onclick="resumeCampaign({{ campaign.id }})">
                                            <i class="fas fa-play me-2"></i>Resume
                                        </a></li>
                                    {% endif %}
                                    <li><a class="dropdown-item" href="#" onclick="viewCampaign({{ campaign.id }})">
                                        <i class="fas fa-eye me-2"></i>View Details
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteCampaign({{ campaign.id }})">
                                        <i class="fas fa-trash me-2"></i>Delete
                                    </a></li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% else %}
    <div class="text-center py-5">
        <i class="fas fa-bullhorn fa-5x text-muted mb-4"></i>
        <h4 class="text-muted">No Voice Campaigns Yet</h4>
        <p class="text-muted mb-4">Create your first campaign to start making bulk voice calls</p>
        <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#createCampaignModal">
            <i class="fas fa-plus me-2"></i>Create Your First Campaign
        </button>
    </div>
{% endif %}

<!-- Create Campaign Modal -->
<div class="modal fade" id="createCampaignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="/campaigns" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-bullhorn me-2"></i>Create Voice Campaign
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    {% if not agents %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            You need to create at least one AI agent before creating campaigns.
                            <a href="/agents" class="alert-link">Create Agent</a>
                        </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <label for="campaign_name" class="form-label">Campaign Name *</label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="campaign_name" 
                            name="name" 
                            required 
                            placeholder="e.g., Q4 Sales Outreach, Customer Survey"
                        >
                    </div>
                    
                    <div class="mb-3">
                        <label for="agent_id" class="form-label">Select Agent *</label>
                        <select class="form-select" id="agent_id" name="agent_id" required>
                            <option value="">Choose an agent...</option>
                            {% for agent in agents %}
                                <option value="{{ agent.id }}">{{ agent.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="csv_file" class="form-label">Upload Contacts (CSV) *</label>
                        <input 
                            type="file" 
                            class="form-control" 
                            id="csv_file" 
                            name="csv_file" 
                            accept=".csv" 
                            required
                        >
                        <div class="form-text">
                            CSV file must contain a 'phone_number' column. Optional 'name' column for contact names.
                        </div>
                    </div>
                    
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fas fa-info-circle me-2"></i>CSV Format Example
                            </h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered">
                                    <thead>
                                        <tr>
                                            <th>phone_number</th>
                                            <th>name (optional)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>+1234567890</td>
                                            <td>John Doe</td>
                                        </tr>
                                        <tr>
                                            <td>+1987654321</td>
                                            <td>Jane Smith</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <small class="text-muted">
                                <strong>Important:</strong> Always include country codes (e.g., +1 for US numbers)
                            </small>
                        </div>
                    </div>
                    
                    <div id="csvPreview" class="mt-3" style="display: none;">
                        <h6>CSV Preview</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped" id="previewTable">
                                <thead id="previewHeader"></thead>
                                <tbody id="previewBody"></tbody>
                            </table>
                        </div>
                        <p class="text-muted small" id="previewInfo"></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" {{ 'disabled' if not agents }}>
                        <i class="fas fa-upload me-2"></i>Create Campaign
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Campaign Details Modal -->
<div class="modal fade" id="campaignDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>Campaign Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="campaignDetailsContent">
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentCampaignId = null;

// CSV File Preview
document.getElementById('csv_file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const csv = e.target.result;
        const lines = csv.split('\n');
        
        if (lines.length < 2) {
            alert('CSV file must contain at least a header row and one data row');
            return;
        }
        
        const headers = lines[0].split(',').map(h => h.trim());
        const preview = document.getElementById('csvPreview');
        const previewHeader = document.getElementById('previewHeader');
        const previewBody = document.getElementById('previewBody');
        const previewInfo = document.getElementById('previewInfo');
        
        // Check for required columns
        if (!headers.includes('phone_number')) {
            alert('CSV must contain a "phone_number" column');
            return;
        }
        
        // Build header
        previewHeader.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
        
        // Build body (show first 5 rows)
        previewBody.innerHTML = '';
        const dataRows = lines.slice(1, 6);
        dataRows.forEach(line => {
            if (line.trim()) {
                const cells = line.split(',').map(c => c.trim());
                previewBody.innerHTML += '<tr>' + cells.map(c => `<td>${c}</td>`).join('') + '</tr>';
            }
        });
        
        const totalRows = lines.filter(line => line.trim()).length - 1; // Exclude header
        previewInfo.textContent = `Total contacts: ${totalRows} | Showing first 5 rows`;
        
        preview.style.display = 'block';
    };
    reader.readAsText(file);
});

function launchCampaign(campaignId) {
    if (confirm('Are you sure you want to launch this campaign? This will start making calls to all contacts.')) {
        fetch(`/campaigns/${campaignId}/launch`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert(`Campaign launched! ${data.successful_calls} calls started successfully.`);
                location.reload();
            } else {
                alert('Error launching campaign: ' + (data.detail || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error launching campaign');
        });
    }
}

function pauseCampaign(campaignId) {
    if (confirm('Are you sure you want to pause this campaign?')) {
        fetch(`/campaigns/${campaignId}/pause`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert('Campaign paused successfully!');
                location.reload();
            } else {
                alert('Error pausing campaign');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error pausing campaign');
        });
    }
}

function resumeCampaign(campaignId) {
    if (confirm('Are you sure you want to resume this campaign?')) {
        fetch(`/campaigns/${campaignId}/resume`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert('Campaign resumed successfully!');
                location.reload();
            } else {
                alert('Error resuming campaign');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error resuming campaign');
        });
    }
}

function deleteCampaign(campaignId) {
    if (confirm('Are you sure you want to delete this campaign? This action cannot be undone and will delete all associated call records.')) {
        fetch(`/campaigns/${campaignId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert('Campaign deleted successfully!');
                location.reload();
            } else {
                alert('Error deleting campaign');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting campaign');
        });
    }
}

function viewCampaign(campaignId) {
    currentCampaignId = campaignId;
    const modal = new bootstrap.Modal(document.getElementById('campaignDetailsModal'));
    const content = document.getElementById('campaignDetailsContent');
    
    // Show loading spinner
    content.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    // Load campaign details
    fetch(`/campaigns/${campaignId}/conversations`)
        .then(response => response.json())
        .then(conversations => {
            content.innerHTML = `
                <div class="row mb-3">
                    <div class="col-12">
                        <h6>Campaign Conversations (${conversations.length} total)</h6>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Contact</th>
                                <th>Phone Number</th>
                                <th>Status</th>
                                <th>Duration</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${conversations.map(conv => `
                                <tr>
                                    <td>${conv.contact_name || 'Unknown'}</td>
                                    <td>${conv.phone_number}</td>
                                    <td>
                                        <span class="badge bg-${conv.status === 'completed' ? 'success' : conv.status === 'in_progress' ? 'warning' : conv.status === 'failed' ? 'danger' : 'secondary'}">
                                            ${conv.status}
                                        </span>
                                    </td>
                                    <td>${conv.duration_seconds ? conv.duration_seconds + 's' : '-'}</td>
                                    <td>${new Date(conv.created_at).toLocaleDateString()}</td>
                                    <td>
                                        ${conv.transcript ? '<button class="btn btn-sm btn-outline-primary" onclick="viewTranscript(' + conv.id + ')">View Transcript</button>' : '-'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        })
        .catch(error => {
            console.error('Error:', error);
            content.innerHTML = '<div class="alert alert-danger">Error loading campaign details</div>';
        });
}

function viewTranscript(conversationId) {
    // TODO: Implement transcript viewer
    alert('Transcript viewer coming soon!');
}
</script>
{% endblock %}