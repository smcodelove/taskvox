{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">ðŸ“Š Reports & Analytics</h1>
        <p class="text-muted">Comprehensive analysis of your voice calling performance</p>
    </div>
    <div class="btn-group">
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fas fa-calendar me-2"></i>Last {{ date_range }} Days
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="?date_range=7">Last 7 Days</a></li>
                <li><a class="dropdown-item" href="?date_range=30">Last 30 Days</a></li>
                <li><a class="dropdown-item" href="?date_range=90">Last 90 Days</a></li>
                <li><a class="dropdown-item" href="?date_range=365">Last Year</a></li>
            </ul>
        </div>
        <button class="btn btn-danger" onclick="exportReportPDF()">
            <i class="fas fa-file-pdf me-2"></i>Export PDF
        </button>
        <button class="btn btn-success" onclick="exportReportCSV()">
            <i class="fas fa-file-csv me-2"></i>Export CSV
        </button>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ stats.total_calls }}</h4>
                        <p class="mb-0">Total Calls</p>
                        <small>
                            <i class="fas fa-arrow-up me-1"></i>
                            {{ stats.completed_calls }} completed
                        </small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-phone fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ stats.success_rate }}%</h4>
                        <p class="mb-0">Success Rate</p>
                        <small>
                            <i class="fas fa-check-circle me-1"></i>
                            Industry avg: ~65%
                        </small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ "%.1f"|format(stats.avg_duration) }}s</h4>
                        <p class="mb-0">Avg Call Duration</p>
                        <small>
                            <i class="fas fa-clock me-1"></i>
                            Total: {{ "%.0f"|format(stats.total_duration/60) }}min
                        </small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-stopwatch fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="mb-0">{{ stats.active_agents }}</h4>
                        <p class="mb-0">Active Agents</p>
                        <small>
                            <i class="fas fa-robot me-1"></i>
                            {{ stats.total_campaigns }} campaigns
                        </small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Peak Performance Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-trophy me-2"></i>Peak Performance Insights
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="border-end">
                            <h4 class="text-success">{{ stats.peak_day.date }}</h4>
                            <small class="text-muted">Best Day</small>
                            <br>
                            <small class="text-success">{{ stats.peak_day.calls }} calls</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border-end">
                            <h4 class="text-info">{{ stats.max_duration }}s</h4>
                            <small class="text-muted">Longest Call</small>
                            <br>
                            <small class="text-info">{{ stats.min_duration }}s shortest</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="border-end">
                            <h4 class="text-primary">
                                {% if stats.success_rate >= 70 %}
                                    Excellent
                                {% elif stats.success_rate >= 50 %}
                                    Good
                                {% else %}
                                    Needs Improvement
                                {% endif %}
                            </h4>
                            <small class="text-muted">Performance Grade</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-warning">{{ "%.1f"|format(stats.total_duration/3600) }}hrs</h4>
                        <small class="text-muted">Total Talk Time</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <div class="col-xl-8 col-lg-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-chart-area me-2"></i>Call Performance Trends
                </h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary active" onclick="switchChart('daily')">Daily</button>
                    <button class="btn btn-outline-primary" onclick="switchChart('hourly')">Hourly</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="performanceChart" height="100"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-xl-4 col-lg-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>Call Status Distribution
                </h5>
            </div>
            <div class="card-body">
                <canvas id="statusChart"></canvas>
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-4">
                            <small class="text-muted">Completed</small>
                            <h6 class="text-success">{{ stats.completed_calls }}</h6>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Failed</small>
                            <h6 class="text-danger">{{ stats.failed_calls }}</h6>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">In Progress</small>
                            <h6 class="text-warning">{{ stats.in_progress_calls }}</h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Agent Performance Analysis -->
{% if agent_performance %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-robot me-2"></i>Agent Performance Analysis
                </h5>
                <button class="btn btn-sm btn-outline-primary" onclick="exportAgentReport()">
                    <i class="fas fa-download me-1"></i>Export
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Agent Name</th>
                                <th>Total Calls</th>
                                <th>Success Rate</th>
                                <th>Avg Duration</th>
                                <th>Performance</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for agent in agent_performance %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm bg-primary rounded-circle me-2 d-flex align-items-center justify-content-center">
                                            <i class="fas fa-robot text-white"></i>
                                        </div>
                                        <strong>{{ agent.agent_name }}</strong>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ agent.total_calls }}</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress me-2" style="width: 60px; height: 8px;">
                                            <div class="progress-bar bg-{{ 'success' if agent.success_rate >= 70 else 'warning' if agent.success_rate >= 50 else 'danger' }}" 
                                                 style="width: {{ agent.success_rate }}%"></div>
                                        </div>
                                        <small>{{ "%.1f"|format(agent.success_rate) }}%</small>
                                    </div>
                                </td>
                                <td>{{ "%.1f"|format(agent.avg_duration) }}s</td>
                                <td>
                                    {% if agent.success_rate >= 80 %}
                                        <span class="badge bg-success">Excellent</span>
                                    {% elif agent.success_rate >= 60 %}
                                        <span class="badge bg-info">Good</span>
                                    {% elif agent.success_rate >= 40 %}
                                        <span class="badge bg-warning">Average</span>
                                    {% else %}
                                        <span class="badge bg-danger">Needs Improvement</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="mini-chart" id="trend-{{ agent.agent_id }}">
                                        <canvas width="80" height="30"></canvas>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Campaign Analysis -->
{% if campaign_analysis %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bullhorn me-2"></i>Campaign Performance Analysis
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for campaign in campaign_analysis %}
                    <div class="col-xl-4 col-lg-6 mb-3">
                        <div class="card border-left-primary">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6 class="text-primary">{{ campaign.campaign_name }}</h6>
                                        <p class="text-muted small mb-0">
                                            Status: <span class="badge bg-{{ 'success' if campaign.status == 'completed' else 'warning' if campaign.status == 'running' else 'secondary' }}">{{ campaign.status|title }}</span>
                                        </p>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-info">{{ campaign.completed_calls }}/{{ campaign.total_contacts }}</span>
                                    </div>
                                </div>
                                
                                <div class="mt-2">
                                    <div class="progress mb-1" style="height: 6px;">
                                        <div class="progress-bar bg-success" style="width: {{ campaign.completion_rate }}%"></div>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <small class="text-muted">Completion: {{ "%.1f"|format(campaign.completion_rate) }}%</small>
                                        <small class="text-success">Success: {{ "%.1f"|format(campaign.success_rate) }}%</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Detailed Metrics -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-clock me-2"></i>Call Duration Analysis
                </h5>
            </div>
            <div class="card-body">
                <canvas id="durationChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-day me-2"></i>Weekly Performance
                </h5>
            </div>
            <div class="card-body">
                <canvas id="weeklyChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-download me-2"></i>Export Report
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Export Format</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="exportFormat" id="exportPDF" value="pdf" checked>
                        <label class="form-check-label" for="exportPDF">
                            <i class="fas fa-file-pdf text-danger me-2"></i>PDF Report
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="exportFormat" id="exportCSV" value="csv">
                        <label class="form-check-label" for="exportCSV">
                            <i class="fas fa-file-csv text-success me-2"></i>CSV Data
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="exportFormat" id="exportJSON" value="json">
                        <label class="form-check-label" for="exportJSON">
                            <i class="fas fa-file-code text-info me-2"></i>JSON Data
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Include Sections</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeSummary" checked>
                        <label class="form-check-label" for="includeSummary">Summary Statistics</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeAgents" checked>
                        <label class="form-check-label" for="includeAgents">Agent Performance</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeCampaigns" checked>
                        <label class="form-check-label" for="includeCampaigns">Campaign Analysis</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeCharts">
                        <label class="form-check-label" for="includeCharts">Charts & Graphs</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="performExport()">
                    <i class="fas fa-download me-2"></i>Export Report
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentChart = 'daily';
let performanceChartInstance = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
});

function initializeCharts() {
    renderStatusChart();
    renderPerformanceChart('daily');
    renderDurationChart();
    renderWeeklyChart();
}

function renderStatusChart() {
    const ctx = document.getElementById('statusChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Completed', 'Failed', 'In Progress'],
            datasets: [{
                data: [{{ stats.completed_calls }}, {{ stats.failed_calls }}, {{ stats.in_progress_calls }}],
                backgroundColor: ['#28a745', '#dc3545', '#ffc107'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                }
            }
        }
    });
}

function renderPerformanceChart(type) {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    
    if (performanceChartInstance) {
        performanceChartInstance.destroy();
    }
    
    if (type === 'daily') {
        const dailyData = {{ daily_stats|tojson }};
        
        performanceChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dailyData.map(d => d.date),
                datasets: [{
                    label: 'Total Calls',
                    data: dailyData.map(d => d.total_calls),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Success Rate (%)',
                    data: dailyData.map(d => d.success_rate),
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Total Calls'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Success Rate (%)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                        max: 100
                    }
                }
            }
        });
    } else if (type === 'hourly') {
        const hourlyData = {{ hourly_distribution|tojson }};
        
        performanceChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: hourlyData.map(h => `${h.hour}:00`),
                datasets: [{
                    label: 'Calls per Hour',
                    data: hourlyData.map(h => h.call_count),
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Calls'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Hour of Day'
                        }
                    }
                }
            }
        });
    }
}

function renderDurationChart() {
    const ctx = document.getElementById('durationChart').getContext('2d');
    
    // Sample duration distribution data
    const durationRanges = ['0-30s', '30s-1m', '1-2m', '2-5m', '5m+'];
    const durationCounts = [15, 25, 35, 20, 5]; // Sample data
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: durationRanges,
            datasets: [{
                label: 'Call Count',
                data: durationCounts,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 205, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 205, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Calls'
                    }
                }
            }
        }
    });
}

function renderWeeklyChart() {
    const ctx = document.getElementById('weeklyChart').getContext('2d');
    
    // Sample weekly data
    const weekDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    const weeklyData = [45, 52, 48, 61, 55, 28, 15]; // Sample data
    
    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: weekDays,
            datasets: [{
                label: 'Calls by Day',
                data: weeklyData,
                fill: true,
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                r: {
                    angleLines: {
                        display: true
                    },
                    suggestedMin: 0
                }
            }
        }
    });
}

function switchChart(type) {
    currentChart = type;
    
    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    renderPerformanceChart(type);
}

function exportReportPDF() {
    window.open(`/reports/export/pdf?date_range={{ date_range }}`, '_blank');
}

function exportReportCSV() {
    const modal = new bootstrap.Modal(document.getElementById('exportModal'));
    modal.show();
}

function exportAgentReport() {
    const csvContent = "data:text/csv;charset=utf-8," + 
        "Agent Name,Total Calls,Success Rate,Avg Duration\n" +
        {% for agent in agent_performance %}"{{ agent.agent_name }},{{ agent.total_calls }},{{ agent.success_rate }},{{ agent.avg_duration }}\n" +{% endfor %}"";
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "agent_performance.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function performExport() {
    const format = document.querySelector('input[name="exportFormat"]:checked').value;
    const includeSummary = document.getElementById('includeSummary').checked;
    const includeAgents = document.getElementById('includeAgents').checked;
    const includeCampaigns = document.getElementById('includeCampaigns').checked;
    const includeCharts = document.getElementById('includeCharts').checked;
    
    let exportUrl = `/reports/export/${format}?date_range={{ date_range }}`;
    
    if (!includeSummary) exportUrl += '&exclude=summary';
    if (!includeAgents) exportUrl += '&exclude=agents';
    if (!includeCampaigns) exportUrl += '&exclude=campaigns';
    if (includeCharts) exportUrl += '&include=charts';
    
    window.open(exportUrl, '_blank');
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
}

// Auto-refresh data every 5 minutes
setInterval(() => {
    location.reload();
}, 300000);

// Add smooth animations
document.querySelectorAll('.card').forEach((card, index) => {
    card.style.animationDelay = `${index * 0.1}s`;
    card.classList.add('fade-in');
});
</script>

<style>
.fade-in {
    animation: fadeIn 0.6s ease-in-out forwards;
    opacity: 0;
}

@keyframes fadeIn {
    to {
        opacity: 1;
        transform: translateY(0);
    }
    from {
        opacity: 0;
        transform: translateY(20px);
    }
}

.border-left-primary {
    border-left: 4px solid #007bff !important;
}

.avatar-sm {
    width: 32px;
    height: 32px;
}

.mini-chart {
    width: 80px;
    height: 30px;
}

.card-body {
    position: relative;
}

.progress {
    height: 8px;
    border-radius: 4px;
}

.badge {
    font-size: 0.75rem;
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}

.opacity-75 {
    opacity: 0.75;
}
</style>
{% endblock %}