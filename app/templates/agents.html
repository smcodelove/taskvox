<!-- FILE PATH: app/templates/agents.html -->
<!-- REPLACE YOUR ENTIRE agents.html WITH THIS WHITE-LABEL VERSION -->

{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">AI Voice Agents</h1>
        <p class="text-muted">Create and manage your intelligent voice assistants</p>
    </div>
    <div class="btn-group">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createAgentModal">
            <i class="fas fa-plus me-2"></i>Create Agent
        </button>
        {% if user.voice_api_key %}
            <button class="btn btn-info" onclick="syncVoiceAgents()">
                <i class="fas fa-sync me-2"></i>Sync Agents
            </button>
        {% endif %}
    </div>
</div>

<!-- API Key Setup Banner -->
{% if not user.voice_api_key %}
<div class="alert alert-warning alert-dismissible fade show">
    <i class="fas fa-key me-2"></i>
    <strong>Setup Required:</strong> Configure your Voice AI API key in Settings to create agents.
    <a href="/settings" class="alert-link ms-2">
        <i class="fas fa-cog me-1"></i>Go to Settings
    </a>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<!-- Agents Grid -->
{% if agents %}
    <div class="row">
        {% for agent in agents %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 agent-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ agent.name }}</h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="testAgentCall({{ agent.id }})">
                                <i class="fas fa-phone me-2"></i>Test Call
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="editAgent({{ agent.id }})">
                                <i class="fas fa-edit me-2"></i>Edit
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteAgent({{ agent.id }})">
                                <i class="fas fa-trash me-2"></i>Delete
                            </a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted">Voice Profile</small>
                        <p class="mb-0">{{ agent.voice_id if agent.voice_id else 'Default Voice' }}</p>
                    </div>
                    
                    {% if agent.external_agent_id %}
                    <div class="mb-3">
                        <small class="text-muted">Agent ID</small>
                        <p class="mb-0">
                            <code class="small">{{ agent.external_agent_id[:12] }}...</code>
                            <i class="fas fa-check-circle text-success ms-1" title="Synced with Voice AI"></i>
                        </p>
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <small class="text-muted">Instructions</small>
                        <p class="mb-0 text-truncate" style="max-height: 3rem; overflow: hidden;">
                            {{ agent.system_prompt[:100] + '...' if agent.system_prompt and agent.system_prompt|length > 100 else agent.system_prompt or 'No instructions set' }}
                        </p>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge {{ 'bg-success' if agent.is_active else 'bg-secondary' }}">
                            {{ 'Active' if agent.is_active else 'Inactive' }}
                        </span>
                        <small class="text-muted">
                            Created {{ agent.created_at.strftime('%Y-%m-%d') }}
                        </small>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="text-center py-5">
        <i class="fas fa-robot fa-5x text-muted mb-4"></i>
        <h4 class="text-muted">No Voice Agents Yet</h4>
        <p class="text-muted mb-4">Create your first AI voice agent to start making intelligent calls</p>
        <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#createAgentModal">
            <i class="fas fa-plus me-2"></i>Create Your First Agent
        </button>
    </div>
{% endif %}

<!-- Create Agent Modal -->
<div class="modal fade" id="createAgentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="/agents" id="createAgentForm">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-robot me-2"></i>Create Voice Agent
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    {% if not user.voice_api_key %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            You need to configure your Voice AI API key in settings first.
                            <a href="/settings" class="alert-link">Go to Settings</a>
                        </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <label for="name" class="form-label">Agent Name *</label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="name" 
                            name="name" 
                            required 
                            placeholder="e.g., Sales Assistant, Customer Support"
                        >
                    </div>
                    
                    <div class="mb-3">
                        <label for="voice_id" class="form-label">Voice Profile *</label>
                        <select class="form-select" id="voice_id" name="voice_id" required>
                            <option value="">Select a voice...</option>
                            {% for voice in voices %}
                                <option value="{{ voice.voice_id }}">
                                    {{ voice.name }} ({{ voice.labels.gender if voice.labels.gender else 'Professional' }})
                                </option>
                            {% endfor %}
                        </select>
                        {% if not voices %}
                            <div class="form-text text-warning">
                                No voices available. Please configure your API key first.
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="system_prompt" class="form-label">Agent Instructions *</label>
                        <textarea 
                            class="form-control" 
                            id="system_prompt" 
                            name="system_prompt" 
                            rows="6" 
                            required
                            placeholder="Define how your AI agent should behave and respond to customers..."
                        ></textarea>
                        <div class="form-text">
                            These instructions define your agent's personality, role, and conversation style.
                        </div>
                    </div>
                    
                    <!-- Agent Templates -->
                    <div class="mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-lightbulb me-2"></i>Quick Templates
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="useTemplate('sales')">
                                            Sales Agent
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-outline-success btn-sm w-100 mb-2" onclick="useTemplate('support')">
                                            Support Agent
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-outline-info btn-sm w-100 mb-2" onclick="useTemplate('survey')">
                                            Survey Agent
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-outline-warning btn-sm w-100 mb-2" onclick="useTemplate('appointment')">
                                            Appointment Agent
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" {{ 'disabled' if not user.voice_api_key or not voices }}>
                        <i class="fas fa-save me-2"></i>Create Agent
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Test Call Modal -->
<div class="modal fade" id="testCallModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="testCallForm">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-phone me-2"></i>Test Voice Agent
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>This will make a real phone call!</strong> Make sure you have sufficient credits in your account.
                    </div>
                    
                    <div class="mb-3">
                        <label for="test_phone_number" class="form-label">Phone Number *</label>
                        <input 
                            type="tel" 
                            class="form-control" 
                            id="test_phone_number" 
                            required 
                            placeholder="+1234567890"
                        >
                        <div class="form-text">Include country code (e.g., +1 for US)</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-phone me-2"></i>Make Test Call
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentAgentId = null;

// Agent instruction templates
const agentTemplates = {
    sales: "You are a professional sales assistant for our company. Your goal is to introduce our services to potential customers. Keep calls brief (2-3 minutes), ask about their business needs, and offer to schedule a consultation. Be respectful and professional. If they're not interested, politely thank them and end the call.",
    
    support: "You are a helpful customer support agent. Listen carefully to customer issues, provide clear solutions, and escalate complex problems when needed. Always maintain a patient and professional tone. Ask clarifying questions to better understand their concerns.",
    
    survey: "You are conducting a brief customer feedback survey. Ask 3-5 short questions about their recent experience with our service. Keep the conversation friendly and thank them for their time. If they decline to participate, respect their decision and end the call politely.",
    
    appointment: "You are an appointment scheduling assistant. Your job is to book appointments for our team. Ask about their availability, confirm their contact information, and provide meeting details. Be flexible with scheduling and maintain professionalism."
};

function useTemplate(type) {
    document.getElementById('system_prompt').value = agentTemplates[type];
}

// Sync voice agents (renamed from ElevenLabs sync)
async function syncVoiceAgents() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Syncing...';
    
    try {
        const response = await fetch('/agents/sync-voice-agents', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showToast(`Successfully synced ${data.synced_count} agents!`, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(`Error: ${data.detail}`, 'error');
        }
    } catch (error) {
        showToast('Error syncing agents', 'error');
        console.error('Sync error:', error);
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

// Test agent call
function testAgentCall(agentId) {
    currentAgentId = agentId;
    const modal = new bootstrap.Modal(document.getElementById('testCallModal'));
    modal.show();
}

// Handle test call form
document.addEventListener('DOMContentLoaded', function() {
    const testCallForm = document.getElementById('testCallForm');
    if (testCallForm) {
        testCallForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const phoneNumber = document.getElementById('test_phone_number').value;
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Calling...';
            
            try {
                const formData = new FormData();
                formData.append('phone_number', phoneNumber);
                
                const response = await fetch(`/agents/${currentAgentId}/test-call`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast('Test call initiated successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('testCallModal')).hide();
                    setTimeout(() => window.location.href = '/history', 2000);
                } else {
                    showToast(`Error: ${data.detail || 'Failed to make call'}`, 'error');
                }
            } catch (error) {
                showToast('Error making test call', 'error');
                console.error('Test call error:', error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
    }
});

// Delete agent
async function deleteAgent(agentId) {
    if (!confirm('Are you sure you want to delete this agent? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/agents/${agentId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showToast('Agent deleted successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(`Error: ${data.detail}`, 'error');
        }
    } catch (error) {
        showToast('Error deleting agent', 'error');
        console.error('Delete error:', error);
    }
}

// Edit agent (placeholder)
function editAgent(agentId) {
    showToast('Edit functionality coming soon!', 'info');
}

// Toast notification system
function showToast(message, type = 'info') {
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${getToastColor(type)} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${getToastIcon(type)} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function getToastColor(type) {
    const colors = {
        success: 'success',
        error: 'danger', 
        warning: 'warning',
        info: 'info'
    };
    return colors[type] || 'primary';
}

function getToastIcon(type) {
    const icons = {
        success: 'check-circle',
        error: 'times-circle',
        warning: 'exclamation-triangle', 
        info: 'info-circle'
    };
    return icons[type] || 'bell';
}
</script>

<style>
.agent-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.agent-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

code {
    background-color: #f8f9fa;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.875em;
    color: #2563eb;
}

.toast-container {
    z-index: 9999;
}
</style>
{% endblock %}