{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">AI Agents</h1>
        <p class="text-muted">Create and manage your conversational AI agents</p>
    </div>
    <div class="btn-group">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createAgentModal">
            <i class="fas fa-plus me-2"></i>Create Agent
        </button>
        {% if user.elevenlabs_api_key %}
            <button class="btn btn-info" onclick="syncElevenLabsAgents()">
                <i class="fas fa-sync me-2"></i>Sync ElevenLabs
            </button>
        {% endif %}
    </div>
</div>

<!-- Sync Banner -->
{% if elevenlabs_agents and elevenlabs_agents|length > 0 %}
<div class="alert alert-info alert-dismissible fade show">
    <i class="fas fa-info-circle me-2"></i>
    <strong>Found {{ elevenlabs_agents|length }} agents in your ElevenLabs account!</strong>
    <button class="btn btn-sm btn-outline-primary ms-2" onclick="syncElevenLabsAgents()">
        <i class="fas fa-sync me-1"></i>Import All
    </button>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<!-- Agents Grid -->
{% if agents %}
    <div class="row">
        {% for agent in agents %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ agent.name }}</h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="testAgentCall({{ agent.id }})">
                                <i class="fas fa-phone me-2"></i>Test Call
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="editAgent({{ agent.id }})">
                                <i class="fas fa-edit me-2"></i>Edit
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteAgent({{ agent.id }})">
                                <i class="fas fa-trash me-2"></i>Delete
                            </a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted">Voice ID</small>
                        <p class="mb-0">{{ agent.voice_id if agent.voice_id else 'Not set' }}</p>
                    </div>
                    
                    {% if agent.elevenlabs_agent_id %}
                    <div class="mb-3">
                        <small class="text-muted">ElevenLabs ID</small>
                        <p class="mb-0">
                            <code class="small">{{ agent.elevenlabs_agent_id[:12] }}...</code>
                            <i class="fas fa-check-circle text-success ms-1" title="Synced with ElevenLabs"></i>
                        </p>
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <small class="text-muted">System Prompt</small>
                        <p class="mb-0 text-truncate" style="max-height: 3rem; overflow: hidden;">
                            {{ agent.system_prompt[:100] + '...' if agent.system_prompt and agent.system_prompt|length > 100 else agent.system_prompt or 'No prompt set' }}
                        </p>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="badge {{ 'bg-success' if agent.is_active else 'bg-secondary' }}">
                            {{ 'Active' if agent.is_active else 'Inactive' }}
                        </span>
                        <small class="text-muted">
                            Created {{ agent.created_at.strftime('%Y-%m-%d') }}
                        </small>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="text-center py-5">
        <i class="fas fa-robot fa-5x text-muted mb-4"></i>
        <h4 class="text-muted">No AI Agents Yet</h4>
        
        {% if elevenlabs_agents and elevenlabs_agents|length > 0 %}
            <p class="text-muted mb-4">We found {{ elevenlabs_agents|length }} agents in your ElevenLabs account</p>
            <button class="btn btn-info btn-lg me-3" onclick="syncElevenLabsAgents()">
                <i class="fas fa-sync me-2"></i>Import Existing Agents
            </button>
        {% else %}
            <p class="text-muted mb-4">Create your first AI agent to start making voice calls</p>
        {% endif %}
        
        <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#createAgentModal">
            <i class="fas fa-plus me-2"></i>Create New Agent
        </button>
    </div>
{% endif %}

<!-- Create Agent Modal -->
<div class="modal fade" id="createAgentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="/agents" id="createAgentForm">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-robot me-2"></i>Create AI Agent
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    {% if not user.elevenlabs_api_key %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            You need to configure your API key in settings before creating agents.
                            <a href="/settings" class="alert-link">Go to Settings</a>
                        </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        <label for="name" class="form-label">Agent Name *</label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="name" 
                            name="name" 
                            required 
                            placeholder="e.g., Sales Assistant, Customer Support"
                        >
                    </div>
                    
                    <div class="mb-3">
                        <label for="voice_id" class="form-label">Voice *</label>
                        <select class="form-select" id="voice_id" name="voice_id" required>
                            <option value="">Select a voice...</option>
                            {% for voice in voices %}
                                <option value="{{ voice.voice_id }}">
                                    {{ voice.name }} ({{ voice.labels.gender if voice.labels.gender else 'Unknown' }})
                                </option>
                            {% endfor %}
                        </select>
                        {% if not voices %}
                            <div class="form-text text-warning">
                                No voices available. Please configure your API key first.
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="system_prompt" class="form-label">System Prompt *</label>
                        <textarea 
                            class="form-control" 
                            id="system_prompt" 
                            name="system_prompt" 
                            rows="6" 
                            required
                            placeholder="Define how your AI agent should behave and respond..."
                        ></textarea>
                        <div class="form-text">
                            This prompt defines your agent's personality, role, and how it should interact with callers.
                        </div>
                    </div>
                    
                    <!-- Quick Prompt Templates -->
                    <div class="mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-lightbulb me-2"></i>Quick Templates
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-outline-primary btn-sm w-100 mb-2" onclick="usePromptTemplate('sales')">
                                            Sales Agent
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-outline-success btn-sm w-100 mb-2" onclick="usePromptTemplate('support')">
                                            Support Agent
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-outline-info btn-sm w-100 mb-2" onclick="usePromptTemplate('survey')">
                                            Survey Agent
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-outline-warning btn-sm w-100 mb-2" onclick="usePromptTemplate('appointment')">
                                            Appointment Setter
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" {{ 'disabled' if not user.elevenlabs_api_key or not voices }}>
                        <i class="fas fa-save me-2"></i>Create Agent
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Test Call Modal -->
<div class="modal fade" id="testCallModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="testCallForm">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-phone me-2"></i>Test Agent Call
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>This will make a real phone call!</strong> Make sure you have sufficient ElevenLabs credits.
                    </div>
                    
                    <div class="mb-3">
                        <label for="test_phone_number" class="form-label">Phone Number *</label>
                        <input 
                            type="tel" 
                            class="form-control" 
                            id="test_phone_number" 
                            required 
                            placeholder="+1234567890"
                        >
                        <div class="form-text">Include country code (e.g., +1 for US)</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-phone me-2"></i>Make Test Call
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentAgentId = null;

// Prompt templates
const promptTemplates = {
    sales: "You are a professional sales assistant for TasKvox AI. Your goal is to introduce our voice AI platform to potential customers. Keep calls brief (2-3 minutes), ask about their business needs, and offer to schedule a demo. Be respectful and don't be pushy. If they're not interested, politely thank them and end the call.",
    
    support: "You are a helpful customer support agent. Listen carefully to customer issues, provide clear solutions, and escalate complex problems to human agents when needed. Always maintain a patient and professional tone. Ask clarifying questions to better understand their issue.",
    
    survey: "You are conducting a brief customer satisfaction survey. Ask 3-5 short questions about their recent experience with our service. Keep the conversation friendly and thank them for their time. If they don't want to participate, respect their decision and end the call politely.",
    
    appointment: "You are an appointment setting assistant. Your job is to schedule appointments for our sales team. Ask about their availability, confirm their contact information, and provide them with the meeting details. Be flexible with scheduling and professional at all times."
};

function usePromptTemplate(type) {
    document.getElementById('system_prompt').value = promptTemplates[type];
}

// Sync ElevenLabs agents
async function syncElevenLabsAgents() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Syncing...';
    
    try {
        const response = await fetch('/agents/sync-elevenlabs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showToast(`Successfully synced ${data.synced_count} agents!`, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(`Error: ${data.detail}`, 'error');
        }
    } catch (error) {
        showToast('Error syncing agents', 'error');
        console.error('Sync error:', error);
    } finally {
        button.disabled = false;
        button.innerHTML = originalText;
    }
}

// Test agent call
function testAgentCall(agentId) {
    currentAgentId = agentId;
    const modal = new bootstrap.Modal(document.getElementById('testCallModal'));
    modal.show();
}

// Handle test call form submission
document.addEventListener('DOMContentLoaded', function() {
    const testCallForm = document.getElementById('testCallForm');
    if (testCallForm) {
        testCallForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const phoneNumber = document.getElementById('test_phone_number').value;
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Calling...';
            
            try {
                const formData = new FormData();
                formData.append('phone_number', phoneNumber);
                
                const response = await fetch(`/agents/${currentAgentId}/test-call`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast('Test call initiated successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('testCallModal')).hide();
                    // Redirect to history to see the call
                    setTimeout(() => window.location.href = '/history', 2000);
                } else {
                    showToast(`Error: ${data.detail || 'Failed to make call'}`, 'error');
                }
            } catch (error) {
                showToast('Error making test call', 'error');
                console.error('Test call error:', error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });
    }
});

// Delete agent
async function deleteAgent(agentId) {
    if (!confirm('Are you sure you want to delete this agent? This will also delete it from ElevenLabs and cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/agents/${agentId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showToast('Agent deleted successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(`Error: ${data.detail}`, 'error');
        }
    } catch (error) {
        showToast('Error deleting agent', 'error');
        console.error('Delete error:', error);
    }
}

// Edit agent (placeholder)
function editAgent(agentId) {
    showToast('Edit functionality coming soon!', 'info');
}

// Toast notification system
function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${getToastColor(type)} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-${getToastIcon(type)} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function getToastColor(type) {
    switch(type) {
        case 'success': return 'success';
        case 'error': return 'danger';
        case 'warning': return 'warning';
        case 'info': return 'info';
        default: return 'primary';
    }
}

function getToastIcon(type) {
    switch(type) {
        case 'success': return 'check-circle';
        case 'error': return 'times-circle';
        case 'warning': return 'exclamation-triangle';
        case 'info': return 'info-circle';
        default: return 'bell';
    }
}
</script>

<style>
/* Custom styles for agents page */
.card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.badge {
    font-size: 0.75rem;
}

.toast-container {
    z-index: 9999;
}

code {
    background-color: #f8f9fa;
    padding: 2px 4px;
    border-radius: 3px;
    font-size: 0.875em;
}

.btn-group .btn {
    transition: all 0.2s ease;
}

.btn-group .btn:hover {
    transform: translateY(-1px);
}

.alert-dismissible .btn-close {
    position: relative;
    top: auto;
    right: auto;
}
</style>
{% endblock %}